var PainterCore={init:function(){var e,t;document.forms.postform&&(e=document.forms.postform.getElementsByClassName("painter-ctrl")[0])&&(t=e.getElementsByTagName("button"))[1]&&(this.data=null,this.time=0,this.btnDraw=t[0],this.btnClear=t[1],this.btnFile=document.getElementsByName("imagefile")[0],this.btnSubmit=document.forms.postform.querySelector('input[type="submit"]'),this.inputNodes=e.getElementsByTagName("input"),t[0].addEventListener("click",this.onDrawClick,!1),t[1].addEventListener("click",this.onCancel,!1))},onDrawClick:function(){var e,t,n=this.parentNode.getElementsByTagName("input");e=+n[0].value,t=+n[1].value,e<1||t<1||Tegaki.open({onDone:PainterCore.onDone,onCancel:PainterCore.onCancel,saveReplay:!1,width:e,height:t})},b64toBlob:function(e){var t,n,i,o,a;for(a=(n=atob(e)).length,i=new Array(a),t=0;t<a;++t)i[t]=n.charCodeAt(t);return o=new Uint8Array(i),new Blob([o])},onDone:function(){var e,t;for(t of((e=PainterCore).btnFile.disabled=!0,e.btnClear.disabled=!1,e.data=Tegaki.flatten().toDataURL("image/png"),!Tegaki.hasCustomCanvas&&Tegaki.startTimeStamp?e.time=Math.round((Date.now()-Tegaki.startTimeStamp)/1e3):e.time=0,e.btnFile.style.visibility="hidden",e.btnDraw.textContent="Edit",e.inputNodes))t.disabled=!0;document.forms.postform.addEventListener("submit",e.onSubmit,!1)},onCancel:function(){var e=PainterCore;for(el of(e.data=null,e.replayBlob=null,e.time=0,e.btnFile.disabled=!1,e.btnClear.disabled=!0,e.btnFile.style.visibility="",e.btnDraw.textContent="Paint!",e.inputNodes))el.disabled=!1;document.forms.postform.removeEventListener("submit",e.onSubmit,!1)},onSubmit:function(e){var t,n,i;e.preventDefault(),t=new FormData(this),(n=PainterCore.b64toBlob(PainterCore.data.slice(PainterCore.data.indexOf(",")+1)))&&t.append("imagefile",n,"oekaki.png"),(i=new XMLHttpRequest).open("POST",this.action,!0),i.withCredentials=!0,i.onerror=PainterCore.onSubmitError,i.onload=PainterCore.onSubmitDone,i.send(t),PainterCore.btnSubmit.disabled=!0},onSubmitError:function(){PainterCore.btnSubmit.disabled=!1,showPostFormError("Connection Error.")},onSubmitDone:function(){var e,t;PainterCore.btnSubmit.disabled=!1,t=location.pathname.split(/\//)[1],"0"==(e=document.postform.replythread.value)?(PainterCore.btnClear.disabled=!0,window.location.reload()):window.location.href="/"+t+"/res/"+e+".html"}};